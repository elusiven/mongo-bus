<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoBus Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-counter { padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px; }
        .card-pending { background-color: #007bff; }
        .card-processed { background-color: #28a745; }
        .card-dead { background-color: #dc3545; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">MongoBus Monitoring Dashboard</span>
    </div>
</nav>

<div class="container">
    <div class="row" id="counters">
        <div class="col-md-4">
            <div class="card-counter card-pending">
                <span class="fs-4">Pending</span>
                <h2 id="pending-count">-</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-counter card-processed">
                <span class="fs-4">Processed</span>
                <h2 id="processed-count">-</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-counter card-dead">
                <span class="fs-4">Dead</span>
                <h2 id="dead-count">-</h2>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Endpoints</h3>
            <div class="card">
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Endpoint ID</th>
                            <th>Pending</th>
                            <th>Processed</th>
                            <th>Dead</th>
                        </tr>
                        </thead>
                        <tbody id="endpoint-stats">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Recent Failures</h3>
            <div class="card">
                <div class="card-body">
                    <table class="table table-hover">
                        <thead class="table-danger">
                        <tr>
                            <th>Time</th>
                            <th>Endpoint</th>
                            <th>Type</th>
                            <th>Error</th>
                        </tr>
                        </thead>
                        <tbody id="recent-failures">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function updateStats() {
        try {
            // Use relative path for API to work when hosted under a subpath
            const response = await fetch('api/stats');
            const data = await response.json();

            document.getElementById('pending-count').innerText = data.pendingCount;
            document.getElementById('processed-count').innerText = data.processedCount;
            document.getElementById('dead-count').innerText = data.deadCount;

            const endpointBody = document.getElementById('endpoint-stats');
            endpointBody.innerHTML = '';
            data.endpoints.forEach(e => {
                const row = `<tr><td>${e.endpointId}</td><td>${e.pending}</td><td>${e.processed}</td><td>${e.dead}</td></tr>`;
                endpointBody.innerHTML += row;
            });

            const failureBody = document.getElementById('recent-failures');
            failureBody.innerHTML = '';
            data.recentFailures.forEach(f => {
                const row = `<tr>
                    <td>${new Date(f.timestamp).toLocaleString()}</td>
                    <td>${f.endpointId}</td>
                    <td>${f.typeId}</td>
                    <td><small>${f.error}</small></td>
                </tr>`;
                failureBody.innerHTML += row;
            });
        } catch (error) {
            console.error('Error fetching stats:', error);
        }
    }

    setInterval(updateStats, 5000);
    updateStats();
</script>
</body>
</html>
